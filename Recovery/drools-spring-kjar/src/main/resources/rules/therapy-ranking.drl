package rules;

import java.time.LocalDate;
import java.lang.Math;

import com.sbnz.recovery.model.Patient;
import com.sbnz.recovery.model.AppliedTherapy;
import com.sbnz.recovery.model.enums.Gender;
import com.sbnz.recovery.utility.DateUtility;

global String chosenPatientUsername;

declare ApplicableTherapy
	patientUsername: String
	therapy: Therapy
end

declare DeterminedTherapy
end


rule "Rank therapy for patient"
	agenda-group "rank-therapy"
	no-loop
	salience ($matchedIllnessCount + $matchedInjuries.size())
    when
    	$p: Patient(username == chosenPatientUsername, $illnesses: anamnesis)
    	//$p: Patient(username.equals(chosenPatientUsername), $illnesses: anamnesis)
    	//$p: Patient($illnesses: anamnesis)
    	$at: ApplicableTherapy(patientUsername == $p.username, 
    		$t: therapy, $therapyName : therapy.name, 
    		$til: therapy.applicableIllness, $tin: therapy.applicableInjury)
    	$activeInjuries : List() from collect(
				Injury(this.getEndDate() == null) 
				from $p.medicalHistory
		)
    	$matchedIllnessCount : Number(intValue >= $illnesses.size() / 2) from accumulate(
    													Illness($illness : this) from $illnesses
    													and Illness(this == $illness) from $til,
    													count($illness)
    													)
    	accumulate(
    		Injury($injury: this, $injuryType : injuryType) from $activeInjuries
			and InjuryType(id == $injuryType.id) from $tin,
			$matchedInjuries : collectList($injury)
    	)
    	eval($matchedInjuries.size() >= Math.ceil($activeInjuries.size() / 2.0))
    	//not(DeterminedTherapy())
    then
    	System.out.println("Assigned therapy " + $therapyName + " to patient " + $p.getUsername());
    	System.out.println($matchedInjuries);
    	System.out.println($tin);
    	modify($p) { addTherapyForInjury(new AppliedTherapy(LocalDate.now(), $t), (Injury)$matchedInjuries.get(0)); }
		//insert(new DeterminedTherapy());
end


rule "Find all applicable therapies for patient"
	agenda-group "find-therapy"
	salience 1
	when
		$p: Patient(username == chosenPatientUsername, $injuries : medicalHistory)
		//$p: Patient($injuries : medicalHistory)
		//$p: Patient(username.equals(chosenPatientUsername), $injuries : medicalHistory)
		$t: Therapy($maximumApplication : maximumMonthlyApplication, $name : name)
		Number(intValue < $maximumApplication) from accumulate(
			Injury($appliedTherapies : appliedTherapies) from $injuries and
			$applicationPerInjury : Number(intValue > 0) from accumulate(
				AppliedTherapy($at : this,
					$date : applicationDate, $date.isAfter(LocalDate.now().minusDays(30)),
					therapy == $t) from $appliedTherapies,
				count($at)
			),
			sum($applicationPerInjury)
		)
	then
		System.out.println(chosenPatientUsername + " " + $p.getUsername());
		System.out.println("Therapy " + $name + " is applicable for patient with username: " + $p.getUsername());
		insert(new ApplicableTherapy(chosenPatientUsername, $t));
end;
/*
rule "Change agenda group after finding all applicable therapies"
	agenda-group "find-therapy"
	salience 0
	when
		ApplicableTherapy( )
	then
		System.out.println("Focus set to rank-therapy agenda-group");
		kcontext.getKnowledgeRuntime().getAgenda().getAgendaGroup("rank-therapy").setFocus();
end;*/
    	//$matchedInjuryCount : Number($matchedInjuries.size() >= $activeInjuries.size() / 2)
    	//$matchedInjuryCount : Number(intValue >= $activeInjuries.size() / 2) from accumulate(
    		//											Injury($injuryType : injuryType) from $activeInjuries
    			//										and InjuryType(this == $injuryType) from $tin,
    				//									count($injuryType)
    					//								)